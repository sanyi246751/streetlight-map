<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>路燈查修地圖</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #search {
      position: absolute;
      top: 10px; left: 5px; right: 5px;
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      max-width: 300px;
      margin: auto;
    }
    #search input { width: 150px; }
    @media (max-width: 600px) { #search input { width: 120px; } }
    .toggle-btn {
      position: absolute;
      top: 60px;
      right: 10px;
      z-index: 1000;
      background: #007bff;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      user-select: none;
    }
    .leaflet-tooltip {
      font-size: 12px;
      font-weight: bold;
      background: rgba(255,255,255,0.85);
      padding: 2px 5px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<div id="search">
  <input type="text" id="searchInput" list="lampList" placeholder="請輸入路燈編號" />
  <datalist id="lampList"></datalist>
  <button onclick="searchLocation()">查詢</button>
</div>

<div id="map"></div>
<div class="toggle-btn" onclick="toggleTooltips()">隱藏路燈號碼</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
  const SHEET_ID = "1AEzSnycqfuXb59m6E19f2rMBrCc4UxwY5bGp0R6Qnxk";
  const SHEET_NAME = encodeURIComponent("回復表-路燈查修-升冪");
  const sheetUrl = `https://opensheet.vercel.app/${SHEET_ID}/${SHEET_NAME}`;

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' });
  const map = L.map('map', { center: [24.4126, 120.6845], zoom: 14, layers: [osm] });

  const markersCluster = L.markerClusterGroup({ maxClusterRadius: 50 });

  const repairIcon = L.icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34]
  });

  const markers = {};
  const tooltips = [];

  fetch(sheetUrl)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) {
        alert("讀取資料失敗，請確認工作表名稱及網址正確。");
        return;
      }
      const bounds = [];
      const lampList = document.getElementById("lampList");

      data.forEach(row => {
        const id = row["路燈號碼"];
        const lng = parseFloat(row["經度Longitude"]);
        const lat = parseFloat(row["緯度Latitude"]);
        const status = row["維修情形"];

        if (status === "已查修") return;
        if (!id || isNaN(lat) || isNaN(lng)) return;

        const option = document.createElement("option");
        option.value = id;
        lampList.appendChild(option);

        const marker = L.marker([lat, lng], { icon: repairIcon })
          .bindPopup(`路燈編號：${id}<br>維修狀態：${status}<br>座標: ${lat}, ${lng}<br><a href="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}" target="_blank">查看街景</a>`);

        const tooltip = marker.bindTooltip(id, { permanent: true, direction: "top", offset: [0, -10], opacity: 0.95 });
        tooltips.push(tooltip);
        markersCluster.addLayer(marker);
        markers[id] = marker;
        bounds.push([lat, lng]);
      });

      map.addLayer(markersCluster);
      if (bounds.length > 0) {
        map.fitBounds(bounds);
      }
    })
    .catch(() => alert("資料讀取失敗，請稍後再試。"));

  function searchLocation() {
    const input = document.getElementById("searchInput").value.trim();
    if (input.length < 2) {
      alert("請至少輸入 2 碼路燈編號！");
      return;
    }
    const matchedIds = Object.keys(markers).filter(id => id.includes(input));
    if (matchedIds.length === 0) {
      alert("查無符合的路燈編號！");
      return;
    }
    const targetId = matchedIds[0];
    map.setView(markers[targetId].getLatLng(), 18);
    markers[targetId].openPopup();
  }

  document.getElementById("searchInput").addEventListener("keyup", e => {
    if (e.key === "Enter") searchLocation();
  });

  let tooltipsVisible = true;
  function toggleTooltips() {
    tooltipsVisible = !tooltipsVisible;
    document.querySelector(".toggle-btn").textContent = tooltipsVisible ? "隱藏路燈號碼" : "顯示路燈號碼";
    document.querySelectorAll(".leaflet-tooltip").forEach(el => {
      el.style.display = tooltipsVisible ? "block" : "none";
    });
  }
</script>

</body>
</html>
